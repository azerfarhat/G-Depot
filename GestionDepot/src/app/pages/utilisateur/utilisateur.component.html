<!-- src/app/utilisateur/utilisateur.component.html -->

<div class="container">
  <!-- Notification Banner -->
  <div *ngIf="notificationMessage"
       class="notification-banner"
       [class.success]="notificationType === 'success'"
       [class.error]="notificationType === 'error'">
    {{ notificationMessage }}
    <button class="close-notification-btn" (click)="clearNotification()">√ó</button>
  </div>
  <!-- End Notification Banner -->

  <div class="header-section">
    <div class="header-content">
      <h1>Gestion des Utilisateurs</h1>
      <p>G√©rez les acc√®s et les r√¥les des utilisateurs</p>
    </div>
    <button class="add-user-button" (click)="openAddUserModal()">+ Nouvel utilisateur</button>
  </div>

  <div class="summary-cards">
    <div class="card total-card">
      <span class="card-title">Total</span>
      <span class="card-count">{{ totalUsers }}</span>
    </div>
    <div class="card admin-card">
      <span class="card-title">Admins</span>
      <span class="card-count">{{ adminCount }}</span>
    </div>
    <div class="card responsable-card">
      <span class="card-title">Responsables</span>
      <span class="card-count">{{ responsableCount }}</span>
    </div>
    <div class="card employe-card">
      <span class="card-title">Employ√©s</span>
      <span class="card-count">{{ employeCount }}</span>
    </div>
    <div class="card client-card">
      <span class="card-title">Clients</span>
      <span class="card-count">{{ clientCount }}</span>
    </div>
    <div class="card chauffeur-card" *ngIf="chauffeurCount > 0">
      <span class="card-title">Chauffeurs</span>
      <span class="card-count">{{ chauffeurCount }}</span>
    </div>
  </div>

  <div class="user-list-section">
    <h2>Liste des Utilisateurs</h2>
    <div class="search-bar">
      <input type="text" placeholder="Rechercher un utilisateur..." [(ngModel)]="searchTerm">
      <span class="search-icon"><i class="fa-solid fa-magnifying-glass"></i></span>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>R√¥le</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers">
            <td>{{ user.nom }}</td>
            <td>{{ user.email }}</td>
            <td>
              <span [ngClass]="getRoleBadgeClass(user.role)">{{ getDisplayRole(user.role) }}</span>
            </td>
            <td class="action-buttons">
              <!-- Call openEditModal with the user object -->
              <span class="action-icon edit-icon" (click)="openEditModal(user)">‚úé</span>
              <span class="action-icon delete-icon" (click)="deleteUser(user)">üóëÔ∏è</span>
            </td>
          </tr>
          <tr *ngIf="filteredUsers.length === 0">
            <td colspan="4" class="no-results">Aucun utilisateur trouv√©.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add User Modal (for non-chauffeur users) -->
  <div class="modal-overlay" *ngIf="showAddUserModal" (click)="closeAddUserModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Ajouter un nouvel utilisateur</h2>
        <button class="close-button" (click)="closeAddUserModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="submitNewUser()">
          <div class="form-group">
            <label for="nom">Nom :</label>
            <input type="text" id="nom" [(ngModel)]="newUser.nom" name="nom" required>
          </div>
          <div class="form-group">
            <label for="email">Email :</label>
            <input type="email" id="email" [(ngModel)]="newUser.email" name="email" required>
          </div>
          <div class="form-group">
            <label for="motDePasse">Mot de passe :</label>
            <input type="password" id="motDePasse" [(ngModel)]="newUser.motDePasse" name="motDePasse" required>
          </div>
          <div class="form-group">
            <label for="role">R√¥le :</label>
            <select id="role" [(ngModel)]="newUser.role" name="role" required>
              <option value="" disabled>S√©lectionner un r√¥le</option>
              <option *ngFor="let role of roles" [value]="role">{{ getDisplayRole(role) }}</option>
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" class="cancel-button" (click)="closeAddUserModal()">Annuler</button>
            <button type="submit" class="submit-button">Ajouter</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" *ngIf="showEditUserModal && editingUser" (click)="closeEditUserModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Modifier l'utilisateur</h2>
        <button class="close-button" (click)="closeEditUserModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="submitEditUser()">
          <div class="form-group">
            <label for="editNom">Nom :</label>
            <input type="text" id="editNom" [(ngModel)]="editingUser.nom" name="editNom" required>
          </div>
          <div class="form-group">
            <label for="editEmail">Email :</label>
            <input type="email" id="editEmail" [(ngModel)]="editingUser.email" name="editEmail" required>
          </div>
          <div class="form-group">
            <label for="editMotDePasse">Mot de passe : <small>(Laisser vide pour ne pas changer)</small></label>
            <input type="password" id="editMotDePasse" [(ngModel)]="editingUser.motDePasse" name="editMotDePasse">
          </div>
          <div class="form-group">
            <label for="editRole">R√¥le :</label>
            <select id="editRole" [(ngModel)]="editingUser.role" name="editRole" required>
              <option value="" disabled>S√©lectionner un r√¥le</option>
              <option *ngFor="let role of editRoles" [value]="role">{{ getDisplayRole(role) }}</option>
            </select>
          </div>

          <!-- Chauffeur specific fields for EDIT MODAL -->
          <!-- These fields are always present in the DTO, but only required/editable if role is CHAUFFEUR -->
          <ng-container *ngIf="editingUser.role === 'CHAUFFEUR'">
            <hr>
            <h3>Informations Chauffeur</h3>
            <div class="form-group">
              <label for="editTelephone">T√©l√©phone :</label>
              <input type="text" id="editTelephone" [(ngModel)]="editingUser.telephone" name="editTelephone" required>
            </div>
            <div class="form-group">
              <label for="editNumeroPermis">Num√©ro de Permis :</label>
              <input type="text" id="editNumeroPermis" [(ngModel)]="editingUser.numeroPermis" name="editNumeroPermis" required>
            </div>
            <div class="form-group">
              <label for="editMarqueVehicule">Marque V√©hicule :</label>
              <input type="text" id="editMarqueVehicule" [(ngModel)]="editingUser.marqueVehicule" name="editMarqueVehicule" required>
            </div>
            <div class="form-group">
              <label for="editModeleVehicule">Mod√®le V√©hicule :</label>
              <input type="text" id="editModeleVehicule" [(ngModel)]="editingUser.modeleVehicule" name="editModeleVehicule" required>
            </div>
            <div class="form-group">
              <label for="editMatriculeVehicule">Matricule V√©hicule :</label>
              <input type="text" id="editMatriculeVehicule" [(ngModel)]="editingUser.matriculeVehicule" name="editMatriculeVehicule" required>
            </div>
          </ng-container>

          <div class="modal-actions">
            <button type="button" class="cancel-button" (click)="closeEditUserModal()">Annuler</button>
            <button type="submit" class="submit-button">Mettre √† jour</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal for Deletion -->
  <div class="modal-overlay" *ngIf="isConfirmModalOpen">
    <div class="modal-content confirmation-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmation</h3>
        <button class="close-button" (click)="confirmAction(false)">‚úï</button>
      </div>
      <div class="modal-body">
        <p>{{ confirmMessage }}</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="cancel-button" (click)="confirmAction(false)">Annuler</button>
        <button type="button" class="submit-button delete-confirm-button" (click)="confirmAction(true)">Supprimer</button>
      </div>
    </div>
  </div>
</div>