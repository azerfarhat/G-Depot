<div class="inventory-container">
  <div class="card-header">
    <h2>Liste des Bons de Sortie</h2>
    <button class="btn btn-primary" (click)="openCreateBonDeSortieForm()">+ Nouveau Bon de Sortie</button>
  </div>

  <!-- Formulaire de cr√©ation de Bon de Sortie -->
  <div *ngIf="showCreateForm" class="create-form">
    <h3>Cr√©er un nouveau Bon de Sortie</h3>
    <div class="form-group">
      <label for="commandeId">Commande √† utiliser :</label>
      <select id="commandeId" [(ngModel)]="nouvelleCommandeId" (ngModelChange)="onCommandeChange()">
        <option [ngValue]="undefined">-- S√©lectionner une commande valid√©e --</option>
        <option *ngFor="let cmd of commandesValidees" [ngValue]="cmd.id">
          {{ cmd.id }} - {{ cmd.client?.nom || 'Client inconnu' }} (TTC: {{ cmd.totaleCommandeTTC | currency:'TND':'symbol':'1.2-2' }})
        </option>
      </select>
    </div>
    <div class="form-group" *ngIf="nouveauChauffeurId">
      <label>Chauffeur associ√© :</label>
      <span>
        {{ getNomChauffeurAssocie() }}
      </span>
    </div>
    <button class="btn btn-success" (click)="creerNouveauBonDeSortie()">Cr√©er</button>
    <button type="button" class="btn btn-secondary" (click)="showCreateForm = false">Annuler</button>
  </div>

  <div class="content-card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>N¬∞ Bon</th>
            <th>Chauffeur</th>
            <th>Total TTC Initial</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (bds of bonsDeSortie$ | async; track bds.id) {
            <tr>
              <td>{{ bds.numeroBDS }}</td>
              <td>{{ bds.chauffeurNom || 'N/A' }}</td>
              <td>{{ bds.valeurTotaleInitialeTTC | currency:'TND':'symbol':'1.2-2' }}</td>
              <td>
                <span class="status-badge" 
                      [class.status-cree]="bds.statut === StatutBonDeSortie.CREE"
                      [class.status-en-cours]="bds.statut === StatutBonDeSortie.EN_COURS"
                      [class.status-livre]="bds.statut === StatutBonDeSortie.LIVRE"
                      [class.status-partiellement-livre]="bds.statut === StatutBonDeSortie.PARTIELLEMENT_LIVRE"
                      [class.status-retourne]="bds.statut === StatutBonDeSortie.RETOURNE"
                      [class.status-facture]="bds.statut === StatutBonDeSortie.FACTURE"
                      [class.status-partiellement-facture]="bds.statut === StatutBonDeSortie.PARTIELLEMENT_FACTURE"
                      [class.status-annule]="bds.statut === StatutBonDeSortie.ANNULE">
                  {{ bds.statut }}
                </span>
              </td>
              <td class="actions-cell">
                <button (click)="openDetailsModal(bds)" title="Voir d√©tails et factures">üëÅÔ∏è</button>
                <button (click)="openRetourModal(bds)" title="G√©rer les retours">‚Ü©Ô∏è</button>
                <button (click)="openFacturationModal(bds)" title="Cr√©er une facture pour ce BDS">üßæ</button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5" class="no-data">Aucun bon de sortie trouv√©.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modale de D√©tails du Bon de Sortie -->
<div class="modal-overlay" *ngIf="selectedBdsForDetails" (click)="closeDetailsModal()">
  <div class="modal-content bds-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>D√©tails du Bon de Sortie #{{ selectedBdsForDetails.id }} ({{ selectedBdsForDetails.numeroBDS }})</h3>
      <button class="close-btn" (click)="closeDetailsModal()">√ó</button>
    </div>
    <div class="modal-body">
      <h4>Informations G√©n√©rales</h4>
      <p><strong>Chauffeur:</strong> {{ selectedBdsForDetails.chauffeur?.nom || 'N/A' }}</p>
      <p><strong>Date de Sortie:</strong> {{ selectedBdsForDetails.dateSortie | date:'mediumDate' }}</p>
      <p><strong>Statut:</strong> {{ selectedBdsForDetails.statut }}</p>
      <p><strong>Commande d'Origine:</strong>
        @if (selectedBdsForDetails.commandeOrigineId) {
          <a [routerLink]="['/commandes', selectedBdsForDetails.commandeOrigineId]">{{ selectedBdsForDetails.commandeOrigineId }}</a>
        } @else {
          N/A
        }
      </p>
      <p><strong>Valeur Initiale:</strong> {{ selectedBdsForDetails.valeurTotaleInitialeTTC | currency:'TND':'symbol':'1.2-2' }}</p>

      <h4>Lignes du Bon de Sortie</h4>
      <div class="table-wrapper">
        <table>
          <thead>
              <tr>
                  <th>Produit</th>
                  <th>Qt√© Sortie</th>
                  <th>Qt√© Retourn√©e</th>
                  <th>Qt√© Factur√©e</th>
                  <th>Qt√© Dispo Fact.</th>
                  <th>Prix Unitaire TTC</th>
              </tr>
          </thead>
          <tbody>
              @for (ligne of selectedBdsForDetails.lignes; track ligne.id) {
                  <tr>
                      <td>{{ ligne.nomProduit }}</td>
                      <td>{{ ligne.quantiteSortie }}</td>
                      <td>{{ ligne.quantiteRetournee }}</td>
                      <td>{{ ligne.quantiteFacturee }}</td>
                      <td><strong>{{ ligne.quantiteDisponiblePourFacturation }}</strong></td>
                      <td>{{ ligne.prixUnitaireTTC | currency:'TND':'symbol':'1.2-2' }}</td>
                  </tr>
              } @empty {
                  <tr><td colspan="6">Aucune ligne de produit.</td></tr>
              }
          </tbody>
        </table>
      </div>

      <h4>Factures Li√©es</h4>
      <div class="table-wrapper">
        <table>
          <thead>
              <tr><th>N¬∞ Facture</th><th>Montant TTC</th><th>Date Fact.</th><th>Statut</th></tr>
          </thead>
          <tbody>
              @for (facture of selectedBdsForDetails.factures; track facture.id) {
                  <tr>
                      <td>{{ facture.numeroFacture }}</td>
                      <td>{{ facture.totalTTC | currency:'TND':'symbol':'1.2-2' }}</td>
                      <td>{{ facture.dateFacturation | date:'mediumDate' }}</td>
                      <td>{{ facture.statut }}</td>
                  </tr>
              } @empty {
                  <tr><td colspan="4">Aucune facture li√©e.</td></tr>
              }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modale des Retours -->
<div class="modal-overlay" *ngIf="selectedBdsForReturn" (click)="closeRetourModal()">
  <div class="modal-content bds-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
        <h3>Enregistrer les Retours - {{ selectedBdsForReturn.numeroBDS }}</h3>
        <button class="close-btn" (click)="closeRetourModal()">√ó</button>
    </div>
    <div class="modal-body">
        <h4>Produits √† Retourner</h4>
        <div class="table-wrapper">
          <table>
            <thead>
                <tr>
                    <th>Produit</th>
                    <th>Qt√© Sortie</th>
                    <th>Qt√© D√©j√† Retourn√©e</th>
                    <th>Qt√© Dispo Retour</th>
                    <th>Qt√© √† Retourner</th>
                </tr>
            </thead>
            <tbody>
                @for (ligne of selectedBdsForReturn.lignes; track ligne.id) {
                    <tr>
                        <td>{{ ligne.nomProduit }}</td>
                        <td>{{ ligne.quantiteSortie }}</td>
                        <td>{{ ligne.quantiteRetournee }}</td>
                        <td>{{ ligne.quantiteSortie - ligne.quantiteRetournee }}</td>
                        <td class="form-group">
                          <input 
                            type="number" 
                            [value]="quantitesRetourneesMap.get(ligne.id)" 
                            (input)="onQuantiteRetourneeChange(ligne.id, $event)" 
                            min="0" 
                            [max]="ligne.quantiteSortie - ligne.quantiteRetournee"
                            [disabled]="(ligne.quantiteSortie - ligne.quantiteRetournee) <= 0"
                          >
                        </td>
                    </tr>
                } @empty {
                    <tr><td colspan="5">Aucune ligne de produit pour ce Bon de Sortie.</td></tr>
                }
            </tbody>
          </table>
        </div>
    </div>
    <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeRetourModal()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="enregistrerRetours()">Enregistrer les Retours</button>
    </div>
  </div>
</div>

<!-- Modale de Cr√©ation de Facture par Chauffeur -->
<div class="modal-overlay" *ngIf="selectedBdsForFacturation" (click)="closeFacturationModal()">
  <div class="modal-content bds-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cr√©er Facture pour Bon de Sortie #{{ selectedBdsForFacturation.id }}</h3>
      <button class="close-btn" (click)="closeFacturationModal()">√ó</button>
    </div>
    <!-- *** CORRECTED SECTION STARTS HERE *** -->
    <div class="modal-body">
      <!-- Section 1: A read-only table showing all available products on this BDS for context -->
      <h4>Produits sur ce Bon de Sortie</h4>
      <div class="table-wrapper" style="max-height: 200px; margin-bottom: 1.5rem;">
        <table>
          <thead>
              <tr>
                  <th>Produit</th>
                  <th>Qt√© Dispo. Facturation</th>
                  <th>Qt√© D√©j√† Factur√©e</th>
              </tr>
          </thead>
          <tbody>
              @for (ligne of selectedBdsForFacturation.lignes; track ligne.id) {
                  <!-- Add a class to gray out lines that are fully invoiced -->
                  <tr [class.text-muted]="ligne.quantiteDisponiblePourFacturation <= 0">
                      <td>{{ ligne.nomProduit }}</td>
                      <td><strong>{{ ligne.quantiteDisponiblePourFacturation }}</strong></td>
                      <td>{{ ligne.quantiteFacturee }}</td>
                  </tr>
              } @empty {
                  <tr><td colspan="3">Aucun produit trouv√© pour ce bon de sortie.</td></tr>
              }
          </tbody>
        </table>
      </div>
    
      <!-- Section 2: The form for creating the new invoice line -->
      <h4>Ajouter une ligne √† la facture</h4>
      <div class="form-group">
        <label for="produitFacture">Produit √† facturer :</label>
        <select id="produitFacture" [(ngModel)]="factureChauffeurProduitId" class="form-control">
          <option [ngValue]="undefined">-- S√©lectionner un produit --</option>
          @for (ligne of selectedBdsForFacturation.lignes; track ligne.id) {
            <!-- Only show products that have a quantity available to be invoiced -->
            @if (ligne.quantiteDisponiblePourFacturation > 0) {
              <option [ngValue]="ligne.produitId">
                {{ ligne.nomProduit }} (Max: {{ ligne.quantiteDisponiblePourFacturation }})
              </option>
            }
          }
        </select>
      </div>
    
      <div class="form-group">
        <label for="quantiteFacture">Quantit√© :</label>
        <input type="number" 
               id="quantiteFacture" 
               [(ngModel)]="factureChauffeurQuantite" 
               placeholder="Quantit√© √† facturer"
               min="1"
               class="form-control" />
      </div>
      
      <button class="btn btn-primary" (click)="creerFactureChauffeur()">Cr√©er Facture</button>
    </div>
    <!-- *** CORRECTED SECTION ENDS HERE *** -->
  </div>
</div>