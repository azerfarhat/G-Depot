<div class="facture-list-container">
  <div class="card-header">
    <h2>Liste des Factures</h2>
  </div>

  <div class="actions">
    <select [(ngModel)]="filtreStatut" (change)="loadFactures()">
      <option value="">Tous les statuts</option>
      @for (statut of statuts; track statut) {
        <option [value]="statut">{{ statut }}</option>
      }
    </select>
  </div>

  <div class="content-card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>N° Facture</th>
            <th>Client/Chauffeur</th>
            <th>Commande/BDS ID</th>
            <th>Date Facturation</th>
            <th>Date Échéance</th>
            <th>Total TTC</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (facture of factures; track facture.id) {
            <tr>
              <td>{{ facture.numeroFacture }}</td>
              <td>
                @if (facture.client) {
                  Client: {{ facture.client.nom }}
                } @else if (facture.chauffeur) {
                  Chauffeur: {{ facture.chauffeur.nom }}
                } @else {
                  N/A
                }
              </td>
              <td>
                @if (facture.commandeId) {
                  Commande: <a [routerLink]="['/commandes', facture.commandeId]">{{ facture.commandeId }}</a>
                } @else if (facture.bonDeSortieId) {
                  BDS: <a [routerLink]="['/bons-de-sortie', facture.bonDeSortieId]">{{ facture.bonDeSortieId }}</a>
                } @else {
                  N/A
                }
              </td>
              <td>{{ facture.dateFacturation | date:'mediumDate' }}</td>
              <td>{{ facture.dateEcheance | date:'mediumDate' }}</td>
              <td>{{ facture.totalTTC | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td>
            <span class="status-badge" 
                    [class.status-emise]="facture.statut === StatutFacture.EMISE"
                    [class.status-payee]="facture.statut === StatutFacture.PAYEE"
                    [class.status-annulee]="facture.statut === StatutFacture.ANNULEE"> <!-- <- ICI ! La balise n'est pas fermée -->
                    {{ facture.statut }}
            </span>
              </td>
              <td class="actions-cell">
                <a [routerLink]="['/factures', facture.id]" class="icon-button" title="Voir détails">👁️</a>
                <button class="icon-button" title="Télécharger PDF" (click)="telechargerPdf(facture.id)">⬇️</button>
                @if (facture.statut === StatutFacture.EMISE) { <!-- Utilise la propriété StatutFacture -->
                  <button class="icon-button" title="Marquer Payée" (click)="updateStatut(facture.id, StatutFacture.PAYEE)">✔️</button>
                  <button class="icon-button" title="Annuler" (click)="updateStatut(facture.id, StatutFacture.ANNULEE)">❌</button>
                } @else if (facture.statut === StatutFacture.PAYEE) { <!-- Utilise la propriété StatutFacture -->
                  <button class="icon-button" title="Annuler (Remboursement)" (click)="updateStatut(facture.id, StatutFacture.ANNULEE)">↩️</button>
                }
              </td>
            </tr>
          } @empty {
            <tr><td colspan="8" class="no-data">Aucune facture trouvée.</td></tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>